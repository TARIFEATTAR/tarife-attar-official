# SKU Synchronization Plan

## Current State

### Systems Involved
1. **Sanity CMS** - Source of truth for new website products
2. **Shopify** - E-commerce backend with actual product variants
3. **Main Website** - Displays products from Sanity

### Current Sync Flow
- ✅ `populate-skus.mjs` - Generates SKUs in Sanity based on product names
- ✅ `sync-skus-to-shopify.mjs` - Syncs SKUs FROM Sanity TO Shopify (one-way)
- ❌ **Missing**: Sync FROM Shopify TO Sanity (for existing products)
- ❌ **Missing**: Bidirectional reconciliation

## SKU Format

### Atlas Products
- **Primary SKU**: `TERRITORY-PRODUCTNAME` (e.g., `TERRA-ONYX`)
- **6ml Variant**: `TERRITORY-PRODUCTNAME-6ML` (e.g., `TERRA-ONYX-6ML`)
- **12ml Variant**: `TERRITORY-PRODUCTNAME-12ML` (e.g., `TERRA-ONYX-12ML`)

### Relic Products
- **Primary SKU**: `RELIC-PRODUCTNAME` (e.g., `RELIC-MAJMUA`)

## Step 1: Diagnose Current State

**Run the diagnostic script to see what's out of sync:**

```bash
node scripts/diagnose-sku-sync.mjs
```

This will show:
- Products with mismatched SKUs
- Products missing SKUs in either system
- Products that exist in one system but not the other
- Legacy Shopify products (safe to ignore)

## Step 2: Populate SKUs in Sanity

**If Sanity is missing SKUs, populate them first:**

```bash
# Preview changes
node scripts/populate-skus.mjs --dry-run

# Apply changes
node scripts/populate-skus.mjs
```

This generates SKUs based on product names and territories.

## Step 3: Sync SKUs to Shopify

**Push Sanity SKUs to Shopify:**

```bash
# Preview changes (RECOMMENDED FIRST)
node scripts/sync-skus-to-shopify.mjs --dry-run

# Apply changes
node scripts/sync-skus-to-shopify.mjs
```

**Safety**: This script only updates products that exist in BOTH systems. Legacy Shopify products are not touched.

## Step 4: Handle Edge Cases

### Products Missing in Shopify
If Sanity has products that don't exist in Shopify:
1. Create products in Shopify manually, OR
2. Update product handles in Sanity to match existing Shopify products

### Products with Different SKUs in Shopify
If Shopify has different SKUs than expected:
1. Review the diagnostic output
2. Decide which system is the source of truth:
   - **New products**: Sanity is source of truth → sync to Shopify
   - **Legacy products**: Shopify is source of truth → sync to Sanity (requires new script)

## Step 5: Ongoing Sync Strategy

### Option A: Sanity as Source of Truth (Recommended for New Products)
- All new products are created in Sanity first
- SKUs are generated in Sanity
- SKUs are synced to Shopify via `sync-skus-to-shopify.mjs`
- **When to run**: After creating/updating products in Sanity

### Option B: Bidirectional Sync (For Existing Products)
- Create a new script: `sync-skus-from-shopify.mjs`
- Fetches SKUs from Shopify and updates Sanity
- **When to run**: For legacy products or when Shopify is manually updated

### Option C: Automated Webhooks
- Set up Shopify webhooks to notify when SKUs change
- Update Sanity automatically (requires API endpoint)

## Recommended Workflow

### Initial Setup (One-Time)
1. ✅ Run `diagnose-sku-sync.mjs` to see current state
2. ✅ Run `populate-skus.mjs` to ensure Sanity has all SKUs
3. ✅ Run `sync-skus-to-shopify.mjs --dry-run` to preview changes
4. ✅ Run `sync-skus-to-shopify.mjs` to apply changes

### Ongoing Maintenance
1. **When creating new products in Sanity:**
   - SKUs are auto-generated by `populate-skus.mjs`
   - Run `sync-skus-to-shopify.mjs` to push to Shopify

2. **When SKUs change in Shopify manually:**
   - Run `diagnose-sku-sync.mjs` to see differences
   - Decide if Sanity should be updated (requires new script) or if Shopify should be corrected

3. **Regular health check:**
   - Run `diagnose-sku-sync.mjs` weekly/monthly to catch drift

## Next Steps

1. **Immediate**: Run diagnostic to see current state
2. **Short-term**: Fix any mismatches using existing scripts
3. **Long-term**: Consider creating `sync-skus-from-shopify.mjs` for bidirectional sync

## Environment Variables Required

```bash
# Sanity
SANITY_WRITE_TOKEN=your_token_here

# Shopify
SHOPIFY_ADMIN_ACCESS_TOKEN=shpat_xxx
NEXT_PUBLIC_SHOPIFY_STORE_DOMAIN=vasana-perfumes.myshopify.com
```

## Troubleshooting

### "Missing SHOPIFY_ADMIN_ACCESS_TOKEN"
1. Go to Shopify Admin → Settings → Apps and sales channels
2. Click "Develop apps" → "Create an app"
3. Configure Admin API scopes: `write_products`, `read_products`
4. Install the app and copy the Admin API access token
5. Set as environment variable: `export SHOPIFY_ADMIN_ACCESS_TOKEN="shpat_xxx"`

### "Products not matching"
- Check that product handles/slugs match between systems
- Verify product titles are similar (matching is done by handle, then by normalized title)

### "SKUs not updating in Shopify"
- Verify Admin API token has `write_products` scope
- Check Shopify API version is correct (currently `2024-10`)
- Review Shopify API error messages in script output
